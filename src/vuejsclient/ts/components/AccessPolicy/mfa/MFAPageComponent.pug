.mfa-page
    .container
        .header
            h1.title
                i.fa.fa-shield-alt
                span {{ label('mfa.page.title') }}
            
            .navigation(v-if="!isForcedConfig")
                button.btn.btn-secondary(v-on:click="goToUserPage")
                    i.fa.fa-arrow-left
                    span {{ label('mfa.page.back_to_account') }}

        // Message d'information pour la configuration forcée
        .forced-config-notice(v-if="isForcedConfig")
            .alert.alert-warning
                i.fa.fa-exclamation-triangle
                span {{ label('mfa.forced.notice') }}

        // Chargement
        .loading-section(v-if="loading || userDataLoading")
            .loading-spinner
                i.fa.fa-spinner.fa-spin
                span(v-if="userDataLoading") {{ label('mfa.page.loading_user') }}
                span(v-else) {{ label('mfa.page.loading') }}

        // État MFA actuel
        .current-status(v-if="!loading && !userDataLoading && !isConfiguring && user")
            .status-card(v-if="isMFAEnabled", class="enabled")
                .status-header
                    .status-icon
                        i.fa.fa-shield-alt.text-success
                    .status-info
                        h2 {{ label('mfa.page.status.enabled') }}
                        p.method-info {{ label('mfa.page.status.method') }} {{ currentMethodLabel }}

                .status-details(v-if="mfaConfig")
                    .detail-item
                        span.label {{ label('mfa.page.status.last_used') }}
                        span.value(v-if="mfaConfig.last_used_date") {{ formatDate(mfaConfig.last_used_date) }}
                        span.value(v-else) {{ label('mfa.page.status.never_used') }}
                    
                    .detail-item
                        span.label {{ label('mfa.page.status.created_date') }}
                        span.value {{ formatDate(mfaConfig.created_date) }}

                .status-actions
                    button.btn.btn-warning(v-on:click="modifyMFA", :disabled="loading")
                        i.fa.fa-edit
                        span {{ label('mfa.page.action.modify') }}
                    
                    p.text-muted.small.mt-2 {{ label('mfa.info.desactivation_impossible') }}

            .status-card(v-else, class="disabled")
                .status-header
                    .status-icon
                        i.fa.fa-exclamation-triangle.text-warning
                    .status-info
                        h2 {{ label('mfa.page.status.disabled') }}
                        p {{ label('mfa.page.status.disabled_desc') }}

                .status-description
                    p {{ label('mfa.page.description.security') }}
                    p {{ label('mfa.page.description.protection') }}

                .status-actions
                    button.btn.btn-primary.btn-large(v-on:click="startMFAConfiguration", :disabled="loading")
                        i.fa.fa-shield-alt
                        span {{ label('mfa.page.action.enable') }}

        // Configuration MFA
        .configuration-section(v-if="isConfiguring && !isActivating && user && !userDataLoading")
            .config-card
                h2
                    i.fa.fa-cog
                    span {{ label('mfa.page.config.title') }}

                .method-selection
                    h3 {{ label('mfa.page.config.choose_method') }}
                    
                    .method-options
                        .method-option(:class="{ selected: selectedMethod === MFA_METHOD_AUTHENTICATOR }")
                            input(type="radio", :value="MFA_METHOD_AUTHENTICATOR", v-model="selectedMethod", id="method-auth")
                            label(for="method-auth")
                                .method-icon
                                    i.fa.fa-mobile-alt
                                .method-info
                                    h4 {{ label('mfa.page.config.method.authenticator') }}
                                    p.recommended {{ label('mfa.page.config.method.recommended') }}
                                    p {{ label('mfa.page.config.method.authenticator_desc') }}

                        .method-option(:class="{ selected: selectedMethod === MFA_METHOD_EMAIL }")
                            input(type="radio", :value="MFA_METHOD_EMAIL", v-model="selectedMethod", id="method-email")
                            label(for="method-email")
                                .method-icon
                                    i.fa.fa-envelope
                                .method-info
                                    h4 {{ label('mfa.method.email') }}
                                    p {{ label('mfa.page.config.method.email_desc') }} {{ user ? user.email : '...' }}

                        .method-option(:class="{ selected: selectedMethod === MFA_METHOD_SMS }")
                            input(type="radio", :value="MFA_METHOD_SMS", v-model="selectedMethod", id="method-sms")
                            label(for="method-sms")
                                .method-icon
                                    i.fa.fa-sms
                                .method-info
                                    h4 {{ label('mfa.method.sms') }}
                                    p {{ label('mfa.page.config.method.sms_desc') }}

                // Configuration SMS
                .sms-config(v-if="selectedMethod === MFA_METHOD_SMS")
                    .form-group
                        label(for="phone-number") {{ label('mfa.page.config.phone_label') }}
                        input#phone-number(
                            type="tel", 
                            v-model="phoneNumber", 
                            placeholder="+33 6 12 34 56 78",
                            required
                        )

                .config-actions
                    button.btn.btn-primary(v-on:click="configureMFA", :disabled="loading || (selectedMethod === MFA_METHOD_SMS && !phoneNumber)")
                        i.fa.fa-arrow-right
                        span {{ label('mfa.page.action.continue') }}

                    button.btn.btn-secondary(v-if="!isForcedConfig", v-on:click="cancelConfiguration", :disabled="loading")
                        i.fa.fa-times
                        span {{ label('mfa.cancel') }}

        // Activation MFA
        .activation-section(v-if="isActivating && user && !userDataLoading")
            .activation-card
                h2
                    i.fa.fa-check-circle
                    span {{ label('mfa.page.activation.title') }}

                // Instructions pour Authenticator avec QR Code
                .authenticator-setup(v-if="selectedMethod === MFA_METHOD_AUTHENTICATOR && showQRCode")
                    .setup-steps
                        h3 {{ label('mfa.page.activation.authenticator_setup') }}

                        .step
                            .step-number 1
                            .step-content
                                h4 {{ label('mfa.page.activation.step1') }}
                                p {{ label('mfa.page.activation.step1_desc') }}

                        .qr-code-container
                            qr-code(:data="qrCodeData", :size="200")

                        .step
                            .step-number 2
                            .step-content
                                h4 {{ label('mfa.page.activation.step2') }}
                                p {{ label('mfa.page.activation.step2_desc') }}
                                .manual-code
                                    code {{ totpSecret }}
                                    button.btn.btn-sm(v-on:click="copyToClipboard(totpSecret)")
                                        i.fa.fa-copy
                                        span {{ label('mfa.page.activation.copy') }}

                        .step
                            .step-number 3
                            .step-content
                                h4 {{ label('mfa.page.activation.step3') }}
                                .app-list
                                    .app-item
                                        i.fa.fa-android
                                        span {{ label('mfa.page.activation.app.google') }}
                                    .app-item
                                        i.fa.fa-microsoft
                                        span {{ label('mfa.page.activation.app.microsoft') }}
                                    .app-item
                                        i.fa.fa-lock
                                        span {{ label('mfa.page.activation.app.authy') }}
                                    .app-item
                                        i.fa.fa-key
                                        span {{ label('mfa.page.activation.app.onepassword') }}

                // Instructions pour les autres méthodes
                .other-method-setup(v-if="selectedMethod !== MFA_METHOD_AUTHENTICATOR")
                    .setup-instructions
                        p(v-if="selectedMethod === MFA_METHOD_EMAIL") 
                            | {{ label('mfa.page.activation.email_desc') }} 
                            strong {{ user ? user.email : '...' }}
                        
                        p(v-if="selectedMethod === MFA_METHOD_SMS") 
                            | {{ label('mfa.page.activation.sms_desc') }} 
                            strong {{ phoneNumber }}

                    .send-code-section
                        button.btn.btn-info(v-on:click="sendVerificationCode", :disabled="loading")
                            i.fa.fa-paper-plane
                            span {{ label('mfa.page.activation.send_code') }}

                // Vérification du code
                .verification-section
                    .form-group
                        label(for="verification-code") {{ label('mfa.code_placeholder') }}
                        input#verification-code(
                            type="text", 
                            v-model="verificationCode", 
                            placeholder="123456",
                            maxlength="6",
                            class="verification-input"
                        )
                        .help-text {{ label('mfa.page.activation.verification_help') }}

                    .verification-actions
                        button.btn.btn-success.btn-large(v-on:click="activateMFA", :disabled="loading || !verificationCode")
                            i.fa.fa-shield-alt
                            span {{ label('mfa.page.action.activate') }}

                        button.btn.btn-secondary(v-if="!isForcedConfig", v-on:click="cancelConfiguration", :disabled="loading")
                            i.fa.fa-times
                            span {{ label('mfa.cancel') }}
