TODO PROJETS PERFS

Modifier les fichiers de configuration de IIS pour séparer les contenus statiques des contenus dynamiques directement dans IIS
EX QUALIFFR

<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <rewrite>

            <!-- Règles OUTBOUND (pour ajouter un header spécifique au service worker, par ex.) -->
            <outboundRules>
                <rule name="Service-Worker-Allowed">
                    <match serverVariable="RESPONSE_Service-Worker-Allowed" pattern=".*" />
                    <action type="Rewrite" value="/" />
                    <conditions>
                        <add input="{REQUEST_URI}" pattern="^/dist/public/client-sw.*\.js$" />
                    </conditions>
                </rule>
            </outboundRules>

            <!-- Règles INBOUND -->
            <rules>
                <clear />
                <rule name="HTTPS" enabled="true" stopProcessing="true">
                    <match url="(.*)" ignoreCase="true" />
                    <conditions logicalGrouping="MatchAny" trackAllCaptures="false">
                        <add input="{HTTPS}" pattern="^OFF$" />
                    </conditions>
                    <action type="Redirect" url="https://qualif.france.yr-resource-planning.com{REQUEST_URI}" appendQueryString="true" redirectType="Permanent" />
                </rule>
                <rule name="test brotli" enabled="false" stopProcessing="true">
                    <match url="^public/(.*)$" />
                    <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
                        <add input="{APPL_PHYSICAL_PATH}dist\public\{R:1}.br" matchType="IsFile" />
                    </conditions>
                    <action type="Rewrite" url="dist/public/{R:1}.br" logRewrittenUrl="true" />
                </rule>
                <rule name="Serve Brotli" enabled="true" stopProcessing="true">
                    <match url="^public/(.*\.([^.]+))$" ignoreCase="true" />
                    <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
                        <add input="{APPL_PHYSICAL_PATH}dist\public\{R:1}.br" matchType="IsFile" />
                        <add input="{HTTP_ACCEPT_ENCODING}" pattern="br" />
                    </conditions>
                    <serverVariables>
                        <set name="RESPONSE_Vary" value="Accept-Encoding" />
                        <set name="RESPONSE_Content-Encoding" value="br" />
                    </serverVariables>
                    <action type="Rewrite" url="dist/public/{R:1}.br" />
                </rule>
                <rule name="Serve Gzipped" enabled="true" stopProcessing="true">
                    <match url="^public/(.*)$" ignoreCase="true" />
                    <conditions logicalGrouping="MatchAll" trackAllCaptures="false">
                        <add input="{HTTP_ACCEPT_ENCODING}" pattern="gzip" />
                        <add input="{APPL_PHYSICAL_PATH}dist\public\{R:1}.gz" matchType="IsFile" />
                    </conditions>
                    <serverVariables>
                        <set name="RESPONSE_Vary" value="Accept-Encoding" />
                        <set name="RESPONSE_Content-Encoding" value="gzip" />
                    </serverVariables>
                    <action type="Rewrite" url="dist/public/{R:1}.gz" />
                </rule>
                <rule name="Static Files" enabled="true" stopProcessing="true">
                    <match url="^public/(.*)$" ignoreCase="true" />
                    <conditions logicalGrouping="MatchAll" trackAllCaptures="false" />
                    <action type="Rewrite" url="dist/public/{R:1}" />
                </rule>
                <rule name="myapp" enabled="true">
                    <match url=".*" ignoreCase="true" />
                    <conditions logicalGrouping="MatchAll" trackAllCaptures="false" />
                    <action type="Rewrite" url="server.js" />
                </rule>
                <!-- On supprime toute règle par défaut -->
                

                <!-- 1. Forcer HTTPS (si besoin) -->
                

                <!-- 2. Servir la version .gz (si Accept-Encoding = gzip) -->
                

                <!-- 3. Servir la version .br (si Accept-Encoding = br) -->
                

                <!-- 4. Servir les fichiers statiques restants depuis dist/public -->
                

                <!-- 5. Catch-all pour le reste : redirection vers server.js (iisnode) -->
                
            </rules>
        </rewrite>

        <!-- Handler IISNode -->
        <handlers>
            <add name="iisnode" path="server.js" verb="*" modules="iisnode" resourceType="File" />
        </handlers>

        <!-- Config iisnode -->
        <iisnode node_env="QUALIFFR" nodeProcessCommandLine="D:\WWWRoot\YR-QUALIFFR\node_modules\.bin\node.cmd --max_old_space_size=6144" nodeProcessStickySessions="true" nodeProcessCountPerApplication="1" debuggingEnabled="false" devErrorsEnabled="false" loggingEnabled="true" logDirectory="iisnode" maxLogFileSizeInKB="2048" maxTotalLogFileSizeInKB="200000" maxLogFiles="50" />
        <urlCompression doStaticCompression="false" />
        
        <!-- (Optionnel) Déclarer le mimeType pour .gz et .br si nécessaire -->
        <!--
        <staticContent>
            <mimeMap fileExtension=".gz" mimeType="application/javascript" />
            <mimeMap fileExtension=".br" mimeType="application/javascript" />
        </staticContent>
        -->

        <staticContent> 
            <mimeMap fileExtension=".css.br" mimeType="text/css" />
            <mimeMap fileExtension=".css.gz" mimeType="text/css" />
            <mimeMap fileExtension=".html.br" mimeType="text/html" />
            <mimeMap fileExtension=".html.gz" mimeType="text/html" />
            <mimeMap fileExtension=".jpg.br" mimeType="image/jpeg" />
            <mimeMap fileExtension=".jpg.gz" mimeType="image/jpeg" />
            <mimeMap fileExtension=".js.br" mimeType="application/javascript" />
            <mimeMap fileExtension=".js.gz" mimeType="application/javascript" />
            <mimeMap fileExtension=".map.br" mimeType="application/json" />
            <mimeMap fileExtension=".map.gz" mimeType="application/json" />
            <mimeMap fileExtension=".png.br" mimeType="image/png" />
            <mimeMap fileExtension=".png.gz" mimeType="image/png" />
            <mimeMap fileExtension=".svg.br" mimeType="image/svg+xml" />
            <mimeMap fileExtension=".svg.gz" mimeType="image/svg+xml" />
            <mimeMap fileExtension=".json.br" mimeType="application/json" />
            <mimeMap fileExtension=".json.gz" mimeType="application/json" />
            <mimeMap fileExtension=".xml.br" mimeType="application/xml" />
            <mimeMap fileExtension=".xml.gz" mimeType="application/xml" />
            <mimeMap fileExtension=".txt.br" mimeType="text/plain" />
            <mimeMap fileExtension=".txt.gz" mimeType="text/plain" />
        </staticContent>


    </system.webServer>
</configuration>
